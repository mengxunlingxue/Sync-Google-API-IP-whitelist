name: Update Google IP CIDR lists

on:
  workflow_dispatch: {}
  schedule:
    # 每小时整点 UTC 运行一次
    - cron: "0 * * * *"

permissions:
  contents: write
  id-token: write

concurrency:
  group: update-cidrs
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check remote metadata (ETag / Last-Modified)
        id: remote
        run: |
          python3 scripts/check_ipranges_remote.py --out data/ipranges.remote.json >> "$GITHUB_OUTPUT"

      - name: Fetch latest ipranges JSON
        if: steps.remote.outputs.changed == 'true'
        run: |
          python3 scripts/fetch_goog_json.py
          python3 scripts/fetch_cloud_json.py

      - name: Ensure files exist for release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # 手动触发时，确保所有文件都存在
          if [ ! -f "data/goog.json" ]; then
            echo "下载 goog.json..."
            python3 scripts/fetch_goog_json.py
          fi
          if [ ! -f "data/cloud.json" ]; then
            echo "下载 cloud.json..."
            python3 scripts/fetch_cloud_json.py
          fi
          if [ ! -f "data/goog.cidr.txt" ]; then
            echo "生成 goog.cidr.txt..."
            python3 scripts/export_goog_cidrs.py
          fi
          if [ ! -f "data/cloud.cidr.txt" ]; then
            echo "生成 cloud.cidr.txt..."
            python3 scripts/export_cloud_cidrs.py
          fi

      - name: Export CIDR (pure list)
        if: steps.remote.outputs.changed == 'true'
        run: |
          python3 scripts/export_goog_cidrs.py
          python3 scripts/export_cloud_cidrs.py

      - name: Commit & push if changed
        id: commit
        run: |
          set -euo pipefail
          if git status --porcelain | grep -E '^( M|A |\\?\\?) (data/goog\\.cidr\\.txt|data/cloud\\.cidr\\.txt|data/ipranges\\.remote\\.json)$' >/dev/null; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/goog.cidr.txt data/cloud.cidr.txt data/ipranges.remote.json
            git commit -m "chore: update CIDR lists"
            git push
            echo "committed=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes in CIDR outputs."
            echo "committed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate release notes
        id: release_notes
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          python3 scripts/generate_release_notes.py > release_notes.txt
          cat release_notes.txt

      - name: Verify files exist before release
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "检查 release 文件..."
          for file in data/goog.json data/cloud.json data/goog.cidr.txt data/cloud.cidr.txt; do
            if [ -f "$file" ]; then
              echo "✓ $file 存在 ($(wc -c < "$file") bytes)"
            else
              echo "✗ 错误: $file 不存在"
              exit 1
            fi
          done

      - name: Create Release
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v$(date +'%Y%m%d-%H%M%S')
          name: "Google IP CIDR 更新 - $(date +'%Y-%m-%d %H:%M:%S') UTC"
          body_path: release_notes.txt
          files: |
            data/goog.json
            data/cloud.json
            data/goog.cidr.txt
            data/cloud.cidr.txt
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

