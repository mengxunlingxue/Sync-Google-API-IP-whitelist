name: Update Google IP CIDR lists

on:
  workflow_dispatch: {}
  schedule:
    # 每小时整点 UTC 运行一次
    - cron: "0 * * * *"

permissions:
  contents: write
  id-token: write

concurrency:
  group: update-cidrs
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check remote metadata (ETag / Last-Modified)
        id: remote
        run: |
          python3 scripts/check_ipranges_remote.py --out data/ipranges.remote.json >> "$GITHUB_OUTPUT"

      - name: Fetch latest ipranges JSON
        if: steps.remote.outputs.changed == 'true'
        run: |
          python3 scripts/fetch_goog_json.py
          python3 scripts/fetch_cloud_json.py

      - name: Ensure files exist for release (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # 手动触发时，确保所有文件都存在
          if [ ! -f "data/goog.json" ]; then
            echo "下载 goog.json..."
            python3 scripts/fetch_goog_json.py
          fi
          if [ ! -f "data/cloud.json" ]; then
            echo "下载 cloud.json..."
            python3 scripts/fetch_cloud_json.py
          fi
          if [ ! -f "data/goog.cidr.txt" ]; then
            echo "生成 goog.cidr.txt..."
            python3 scripts/export_goog_cidrs.py
          fi
          if [ ! -f "data/cloud.cidr.txt" ]; then
            echo "生成 cloud.cidr.txt..."
            python3 scripts/export_cloud_cidrs.py
          fi

      - name: Export CIDR (pure list)
        if: steps.remote.outputs.changed == 'true'
        run: |
          python3 scripts/export_goog_cidrs.py
          python3 scripts/export_cloud_cidrs.py

      - name: Commit & push if changed
        id: commit
        run: |
          set -euo pipefail
          if git status --porcelain | grep -E '^( M|A |\\?\\?) (data/goog\\.cidr\\.txt|data/cloud\\.cidr\\.txt|data/ipranges\\.remote\\.json)$' >/dev/null; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/goog.cidr.txt data/cloud.cidr.txt data/ipranges.remote.json
            git commit -m "chore: update CIDR lists"
            git push
            echo "committed=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes in CIDR outputs."
            echo "committed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate release notes
        id: release_notes
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          python3 scripts/generate_release_notes.py > release_notes.txt
          cat release_notes.txt

      - name: Verify files exist before release
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "检查 release 文件..."
          for file in data/goog.json data/cloud.json data/goog.cidr.txt data/cloud.cidr.txt; do
            if [ -f "$file" ]; then
              echo "✓ $file 存在 ($(wc -c < "$file") bytes)"
            else
              echo "✗ 错误: $file 不存在"
              exit 1
            fi
          done

      - name: Create Release
        if: steps.commit.outputs.committed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          TAG_NAME="v$(date +'%Y%m%d-%H%M%S')"
          RELEASE_NAME="Google IP CIDR 更新 - $(date +'%Y-%m-%d %H:%M:%S') UTC"
          
          # 创建 release
          echo "创建 Release: $TAG_NAME"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"$RELEASE_NAME\",
              \"body\": $(cat release_notes.txt | python3 -c 'import sys, json; print(json.dumps(sys.stdin.read()))'),
              \"draft\": false,
              \"prerelease\": false
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "错误: 创建 release 失败 (HTTP $HTTP_CODE)"
            echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"
            exit 1
          fi
          
          UPLOAD_URL=$(echo "$BODY" | python3 -c "import sys, json; print(json.load(sys.stdin).get('upload_url', '').split('{')[0])" 2>/dev/null || echo "")
          
          if [ -z "$UPLOAD_URL" ]; then
            echo "错误: 无法获取 upload_url"
            echo "$BODY" | python3 -m json.tool
            exit 1
          fi
          
          echo "Release 创建成功，开始上传文件..."
          
          # 上传文件
          for file in data/goog.json data/cloud.json data/goog.cidr.txt data/cloud.cidr.txt; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              echo "上传: $file -> $FILENAME"
              HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@$file" \
                "$UPLOAD_URL?name=$FILENAME")
              
              if [ "$HTTP_CODE" = "201" ]; then
                echo "  ✓ $FILENAME 上传成功"
              else
                echo "  ✗ $FILENAME 上传失败 (HTTP $HTTP_CODE)"
              fi
            else
              echo "警告: $file 不存在，跳过"
            fi
          done
          
          echo ""
          echo "Release 创建完成: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"

